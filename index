<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hotanalysfunktionen – Plan & ansvar 2025–2027</title>

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display:flex; height:100%; }
    #sidebar {
      width: 340px; min-width: 280px; max-width: 420px;
      background: #ffffff; border-right: 1px solid #e5e7eb; overflow:auto;
      padding: 16px 14px;
    }
    #map { flex:1; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    h2 { font-size: 14px; margin: 16px 0 6px; color: #1f2937; }
    .badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; background:#eef2ff; color:#1e3a8a; }
    .section { border:1px solid #f1f5f9; border-radius:8px; padding:10px; margin-bottom:10px; background:#fafafa; }
    .controls label { display:block; margin:4px 0; font-size:14px; }
    .legend { font-size: 12px; color:#374151; }
    .legend i { width:12px; height:12px; display:inline-block; margin-right:6px; border-radius: 2px; vertical-align: -1px; }
    .kpis { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top: 6px; }
    .kpis div { background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:8px; text-align:center; }
    .btn { display:inline-block; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn.active { background:#e0f2fe; border-color:#7dd3fc; }
    .small { font-size:12px; color:#6b7280; }
    .foot { font-size: 11px; color:#6b7280; margin-top:12px; }
    /* Map marker color via class */
    .marker-hotbild { background:#1d4ed8; }
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1>Hotanalysfunktionen <span class="badge">Plan 2025–2027</span></h1>
    <div class="section">
      <h2>Syfte</h2>
      <div class="small">
        • Samlad, aktuell hotbild som beslutsstöd.<br/>
        • Tidig identifiering av förändringar i hotmiljön.<br/>
        • Enhetlig metodik nationellt & regionalt.
      </div>
      <div class="kpis">
        <div><b>6</b><br/><span class="small">Regioner</span></div>
        <div><b>Q2&nbsp;2027</b><br/><span class="small">V2.0 Handledning</span></div>
      </div>
    </div>

    <div class="section controls">
      <h2>Lager</h2>
      <label><input type="checkbox" id="toggleRegions" checked /> T2-regioner</label>
      <label><input type="checkbox" id="toggleHotbilder" checked /> Hotbild (markörer & popups)</label>
      <label><input type="checkbox" id="toggleForum" checked /> Forum (SÄKLT, NRK)</label>
      <label><input type="checkbox" id="toggleMilestones" checked /> Milstenar (plan)</label>
    </div>

    <div class="section">
      <h2>Tidsfilter (kvartal)</h2>
      <div id="qbtns">
        <button class="btn" data-q="all">Alla</button>
        <button class="btn" data-q="2025Q4">2025&nbsp;Q4</button>
        <button class="btn" data-q="2026Q1">2026&nbsp;Q1</button>
        <button class="btn" data-q="2026Q2">2026&nbsp;Q2</button>
        <button class="btn" data-q="2026Q3">2026&nbsp;Q3</button>
        <button class="btn" data-q="2026Q4">2026&nbsp;Q4</button>
        <button class="btn" data-q="2027Q1">2027&nbsp;Q1</button>
        <button class="btn" data-q="2027Q2">2027&nbsp;Q2</button>
      </div>
      <div class="foot">Visa/dölj milstenar efter kvartal.</div>
    </div>

    <div class="section">
      <h2>Teckenförklaring</h2>
      <div class="legend">
        <p><i style="background:#3b82f6"></i> T2-region</p>
        <p><i style="background:#10b981"></i> Hotbildsmarkör</p>
        <p><i style="background:#f59e0b"></i> Forum (SÄKLT/NRK)</p>
        <p><i style="background:#ef4444"></i> Milstenar (plan)</p>
      </div>
    </div>

    <div class="foot">
      Version 2025-11-12 • Visa på en GitHub Pages-sajt. Inga nycklar lagras.
    </div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // --- Bas-karta ---
  const map = L.map('map', { zoomControl: true }).setView([62.3, 16.2], 5);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // --- Lagergrupper ---
  const layerRegions   = L.layerGroup().addTo(map);
  const layerHotbilder = L.layerGroup().addTo(map);
  const layerForum     = L.layerGroup().addTo(map);
  const layerMilestones= L.layerGroup().addTo(map);

  // --- Hjälpfunktion för färgade cirklar ---
  function coloredCircle(lat, lng, color, title, html) {
    const marker = L.circleMarker([lat, lng], {
      radius: 8, stroke:true, weight: 2, color: '#111827',
      fillColor: color, fillOpacity: 0.9
    }).bindPopup(`<b>${title}</b><br>${html}`);
    return marker;
  }

  // --- 6 T2-regioner (exempel-positioner) ---
  const regions = [
    { name: 'Nord (Luleå)',      coords: [65.5848, 22.1547] },
    { name: 'Mitt (Sundsvall)',  coords: [62.3908, 17.3069] },
    { name: 'Stockholm',         coords: [59.3293, 18.0686] },
    { name: 'Öst (Örebro)',      coords: [59.2741, 15.2066] },
    { name: 'Väst (Göteborg)',   coords: [57.7089, 11.9746] },
    { name: 'Syd (Malmö)',       coords: [55.604981, 13.003822] }
  ];
  regions.forEach(r => {
    coloredCircle(r.coords[0], r.coords[1], '#3b82f6',
      `T2-region: ${r.name}`,
      `Regional nod för inhämtning & rapportering.<br>Bidrar till nationell hotbild.`).addTo(layerRegions);
  });

  // --- Hotbild (ansvarsdelar) ---
  const hotbildPoints = [
    {
      title: 'Hotbild – omvärldsdel (Joel)',
      coords: [59.35, 18.06],
      html: 'Nationell omvärldsbevakning, bedömningar, samordning.'
    },
    {
      title: 'Hotbild – anläggningsdel (Eva & Fredrik)',
      coords: [58.4, 14.9],
      html: 'Anläggningsnära bedömningar, indikatorer & trender.'
    }
  ];
  hotbildPoints.forEach(p => {
    coloredCircle(p.coords[0], p.coords[1], '#10b981', p.title, p.html).addTo(layerHotbilder);
  });

  // --- Forum (SÄKLT, NRK) ---
  const forumPoints = [
    {
      title: 'SÄKLT (roterande)',
      coords: [60.6749, 17.1413],
      html: 'Kvartalsvis rotation mellan Joel, Eva, Fredrik.'
    },
    {
      title: 'NRK (Joel sekreterare)',
      coords: [59.334, 18.05],
      html: 'Löpande återrapportering till teamet.'
    }
  ];
  forumPoints.forEach(p => {
    coloredCircle(p.coords[0], p.coords[1], '#f59e0b', p.title, p.html).addTo(layerForum);
  });

  // --- Milstenar (kvartalstaggar för filter) ---
  // qTag = 'YYYYQn' eller 'all'
  const milestones = [
    {
      title: 'Riktlinje fastställs',
      coords: [59.33, 18.07],
      html: 'Riktlinje fastställs (2024-12-19).',
      qTag: '2025Q4'
    },
    {
      title: 'Remisspaket färdigt',
      coords: [59.33, 17.9],
      html: 'Rutin, handledning, mallar (remiss).',
      qTag: '2025Q4'
    },
    {
      title: 'Remiss initieras',
      coords: [59.93, 17.6],
      html: 'Efter nyår 2026; test i två regioner.',
      qTag: '2026Q1'
    },
    {
      title: 'Utbildning startar regioner',
      coords: [57.72, 12.0],
      html: 'Förankring & uppstart; reviderade dokument.',
      qTag: '2026Q2'
    },
    {
      title: 'Alla 6 regioner aktiva',
      coords: [61.0, 14.6],
      html: 'Full regional implementering; Handledning v1.1.',
      qTag: '2026Q3'
    },
    {
      title: 'Kvalitetssäkring & erfarenheter',
      coords: [63.0, 18.0],
      html: 'Identifierade stöd/verktyg; plan för övningar.',
      qTag: '2026Q4'
    },
    {
      title: 'Handledning v2.0',
      coords: [59.1, 18.1],
      html: 'Konsolidering & mognad.',
      qTag: '2027Q2'
    }
  ];

  const milestoneMarkers = milestones.map(m =>
    coloredCircle(m.coords[0], m.coords[1], '#ef4444', m.title, m.html + `<br><span class="small">${m.qTag}</span>`)
      .addTo(layerMilestones)
  );

  // --- UI: Lager toggles ---
  document.getElementById('toggleRegions').addEventListener('change', (e) => {
    e.target.checked ? map.addLayer(layerRegions) : map.removeLayer(layerRegions);
  });
  document.getElementById('toggleHotbilder').addEventListener('change', (e) => {
    e.target.checked ? map.addLayer(layerHotbilder) : map.removeLayer(layerHotbilder);
  });
  document.getElementById('toggleForum').addEventListener('change', (e) => {
    e.target.checked ? map.addLayer(layerForum) : map.removeLayer(layerForum);
  });
  document.getElementById('toggleMilestones').addEventListener('change', (e) => {
    e.target.checked ? map.addLayer(layerMilestones) : map.removeLayer(layerMilestones);
  });

  // --- Tidsfilter: enkel kvartalslogik (hide/show) ---
  const qButtons = document.querySelectorAll('#qbtns .btn');
  let activeQ = 'all';
  function setQuarterFilter(q) {
    activeQ = q;
    qButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.q === q));
    // visa/dölj milstenar
    layerMilestones.clearLayers();
    milestones.forEach((m, idx) => {
      const marker = milestoneMarkers[idx];
      const match = (q === 'all') || (m.qTag === q);
      if (match) marker.addTo(layerMilestones);
    });
  }
  qButtons.forEach(btn => btn.addEventListener('click', () => setQuarterFilter(btn.dataset.q)));
  setQuarterFilter('all');

  // --- Fit bounds to all layers initially ---
  function fitAll() {
    const group = L.featureGroup([
      ...layerRegions.getLayers(),
      ...layerHotbilder.getLayers(),
      ...layerForum.getLayers(),
      ...layerMilestones.getLayers()
    ]);
    if (group.getLayers().length) {
      map.fitBounds(group.getBounds().pad(0.15));
    }
  }
  fitAll();

  // --- Tips i popup om du klickar på kartan ---
  map.on('click', (e) => {
    L.popup()
      .setLatLng(e.latlng)
      .setContent(`Koordinat: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`)
      .openOn(map);
  });
</script>
</body>
</html>
